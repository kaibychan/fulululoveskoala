## PRD 文档：贪食蛇游戏右侧触控摇杆功能

### 功能名称
**右侧触控摇杆**（移动设备优化控制）

### 为什么要加
#### 解决的问题
1. **移动设备操作不便**：现有虚拟方向键按钮布局分散，操作时需要视线在画面和控制区之间切换
2. **单手操作优化**：右侧摇杆支持右手拇指单手持握操作，符合人体工学
3. **触控精度低**：虚拟按钮点击时容易误触相邻方向，摇杆提供连续方向控制
4. **沉浸感不足**：虚拟按钮破坏了游戏画面的完整性

#### 增加的乐趣
1. **街机游戏体验**：模拟传统游戏机的摇杆操作，提升怀旧感和游戏沉浸感
2. **流畅控制感**：连续滑动的操作方式比离散点击更自然、更流畅
3. **操作反馈增强**：摇杆提供视觉和触觉（可选）反馈，提升操作确认感
4. **竞技性提升**：更精准的控制允许玩家尝试更高难度的走位

### 具体需求

#### 1. 基础功能要求
- **右侧固定位置**：摇杆始终固定在游戏画布右侧区域
- **触摸控制**：通过触摸滑动控制蛇的移动方向
- **视觉反馈**：摇杆状态随操作实时变化
- **智能隐藏**：在桌面设备或横屏模式下可自动隐藏

#### 2. 技术实现要求
- **Canvas绘制**：使用Canvas 2D渲染摇杆，确保性能
- **触摸事件处理**：支持touchstart/touchmove/touchend事件
- **方向计算**：根据触摸位置计算8个方向（包括斜向）
- **灵敏度调节**：可调节摇杆死区和灵敏度

#### 3. 用户体验要求
- **立即响应**：触摸开始后立即响应，无延迟
- **操作引导**：首次使用时显示操作提示
- **状态保存**：用户偏好设置保存到localStorage
- **无缝切换**：与键盘控制、虚拟按钮控制无缝兼容

### 详细规格

#### A. 视觉设计
1. **位置与尺寸**
   ```
   手机竖屏（宽度≤768px）：
     - 位置：右侧距边缘10%，垂直居中
     - 尺寸：直径80px（底座），摇杆头直径40px
     
   手机横屏（宽度≤1024px）：
     - 位置：右侧距边缘15%，垂直居中偏下
     - 尺寸：直径100px（底座），摇杆头直径50px
     
   平板设备（宽度>1024px）：
     - 可选显示，用户可在设置中开启/关闭
   ```

2. **视觉样式**
   ```
   摇杆底座：
     - 颜色：rgba(255, 255, 255, 0.15)
     - 边框：2px solid rgba(78, 204, 163, 0.5)
     - 阴影：0 0 15px rgba(78, 204, 163, 0.3)
   
   摇杆头（未操作）：
     - 颜色：rgba(78, 204, 163, 0.7)
     - 居中显示
   
   摇杆头（操作中）：
     - 颜色：#4ecca3（完全显示）
     - 随手指位置移动
     - 移动范围限制在底座内
   
   方向指示：
     - 8个方向刻度线，半透明显示
     - 当前激活方向高亮显示
   ```

#### B. 交互逻辑
1. **触摸区域**
   ```
   - 有效触摸区域：以摇杆底座为中心，向外扩展50%的区域
   - 手指进入该区域即激活摇杆控制
   - 手指在区域内移动时，摇杆头跟随（限制在底座内）
   - 手指离开区域时，摇杆头缓慢归位（200ms动画）
   ```

2. **方向计算**
   ```
   输入：触摸点坐标(x, y)
   处理：
     1. 计算相对于摇杆中心的向量
     2. 将向量归一化到单位圆
     3. 根据角度确定8个方向：
        0°-22.5°, 337.5°-360°: 右
        22.5°-67.5°: 右上
        67.5°-112.5°: 上
        112.5°-157.5°: 左上
        157.5°-202.5°: 左
        202.5°-247.5°: 左下
        247.5°-292.5°: 下
        292.5°-337.5°: 右下
   ```

3. **灵敏度设置**
   ```
   三个预设档位：
     - 低灵敏度：需要明显偏移才改变方向（适合新手）
     - 中灵敏度：适中偏移即响应（默认）
     - 高灵敏度：轻微偏移即响应（适合高手）
     
   死区控制：
     - 中心死区半径可调（10%-30%的底座半径）
     - 防止意外操作
   ```

#### C. 技术实现
1. **文件结构**
   ```
   snake.html
     ├── 现有CSS样式
     ├── 新增摇杆CSS样式
     ├── 现有游戏逻辑
     └── 新增Joystick类（包含以下功能）
   ```

2. **Joystick类设计**
   ```javascript
   class Joystick {
     constructor(options) {
       this.canvas = options.canvas;
       this.ctx = options.ctx;
       this.onDirectionChange = options.onDirectionChange;
       // 初始化属性...
     }
     
     // 主要方法
     init() {}        // 初始化摇杆
     draw() {}        // 绘制摇杆
     handleTouchStart(e) {}  // 触摸开始
     handleTouchMove(e) {}   // 触摸移动
     handleTouchEnd(e) {}    // 触摸结束
     updateDirection() {}    // 更新方向
     resize() {}      // 响应式调整
     show() {}        // 显示摇杆
     hide() {}        // 隐藏摇杆
     destroy() {}     // 销毁摇杆
   }
   ```

3. **与现有代码集成点**
   ```
   修改位置：
     1. 在game-container中添加摇杆Canvas层
     2. 扩展handleKeyDown逻辑，加入摇杆方向输入
     3. 修改移动控制按钮的显示逻辑（摇杆激活时隐藏）
     4. 在游戏状态变化时更新摇杆状态
   ```

#### D. 响应式设计
1. **断点处理**
   ```
   @media (max-width: 768px) and (orientation: portrait) {
     /* 手机竖屏：显示摇杆，隐藏虚拟按钮 */
     .mobile-controls { display: none; }
     .joystick-container { display: block; }
   }
   
   @media (max-width: 1024px) and (orientation: landscape) {
     /* 手机横屏/小平板：调整摇杆位置和大小 */
     .joystick-container { 
       right: 5%; 
       width: 100px; 
       height: 100px;
     }
   }
   
   @media (min-width: 1025px) {
     /* 大屏设备：默认隐藏摇杆，提供设置选项 */
     .joystick-container { display: none; }
   }
   ```

2. **横竖屏切换**
   ```
   - 监听orientationchange事件
   - 重新计算摇杆位置和尺寸
   - 保持用户设置（灵敏度、可见性）
   ```

#### E. 设置选项
1. **控制方式选择**
   ```
   用户可在三种控制方式间切换：
     1. 摇杆控制（移动设备推荐）
     2. 虚拟按钮控制（现有功能）
     3. 键盘控制（桌面设备）
     
   设置入口：在游戏界面添加齿轮图标⚙️
   设置保存：使用localStorage存储用户偏好
   ```

2. **摇杆高级设置**
   ```
   - 摇杆可见性：始终显示/游戏时显示/隐藏
   - 灵敏度：低/中/高
   - 摇杆大小：小/中/大
   - 透明度：20%-80%
   - 震动反馈：开启/关闭（支持设备）
   ```

### 成功指标
1. **用户体验指标**
   - 移动设备操作准确率提升 ≥40%
   - 游戏平均得分提升 ≥25%
   - 用户操作失误率降低 ≥35%
   - 用户满意度评分 ≥4.7/5.0

2. **技术性能指标**
   - 触摸响应延迟 <30ms
   - 方向计算准确率 >98%
   - 内存使用增加 <3MB
   - 兼容主流移动浏览器覆盖率 >95%

3. **业务指标**
   - 移动设备用户平均游戏时长增加 ≥20%
   - 移动设备用户留存率提升 ≥15%
   - 用户分享率提升 ≥10%

### 测试计划
1. **设备覆盖**
   ```
   iOS设备：
     - iPhone 12/13/14/15 系列
     - iPad Air/Mini/Pro
     
   Android设备：
     - 三星 Galaxy S21/S22/S23
     - 小米/华为/OPPO主流机型
     
   屏幕尺寸：
     - 小屏：5.5"-6.2"
     - 中屏：6.3"-7.0"
     - 大屏：7.1"-10.9"
   ```

2. **测试场景**
   ```
   功能测试：
     - 基本方向控制准确性
     - 斜向方向识别
     - 灵敏度调节效果
     - 设置保存与恢复
     
   兼容性测试：
     - 不同浏览器内核
     - 不同操作系统版本
     - 横竖屏切换
     
   性能测试：
     - 长时间操作稳定性
     - 内存泄漏检测
     - 触摸响应速度
   ```

### 风险评估与缓解
1. **技术风险**
   ```
   风险：Canvas触摸事件与游戏主循环冲突
   缓解：使用requestAnimationFrame同步，避免事件阻塞
   
   风险：不同浏览器触摸事件差异
   缓解：使用标准化的事件处理方法，添加polyfill
   ```

2. **用户体验风险**
   ```
   风险：用户不习惯摇杆操作
   缓解：提供详细的操作引导，允许切换回虚拟按钮
   
   风险：摇杆遮挡游戏内容
   缓解：使用半透明设计，提供位置调整选项
   ```

### 后续优化路线图
1. **第一阶段（v1.0）**：基础摇杆功能
2. **第二阶段（v1.1）**：高级设置选项
3. **第三阶段（v1.2）**：多指操作支持（双手控制）
4. **第四阶段（v1.3）**：AI辅助控制（自动避障建议）

### 验收标准
1. ✅ 摇杆在移动设备右侧正确显示
2. ✅ 8个方向控制准确无误
3. ✅ 触摸响应流畅无延迟
4. ✅ 与现有控制方式无缝切换
5. ✅ 用户设置持久化保存
6. ✅ 响应式适配各尺寸屏幕
7. ✅ 代码性能符合指标要求
8. ✅ 主流移动设备兼容性通过

---

**PRD版本**：1.0  
**最后更新**：2024年1月  
**相关人员**：产品经理、UI设计师、前端开发、测试工程师  
**状态**：待开发
